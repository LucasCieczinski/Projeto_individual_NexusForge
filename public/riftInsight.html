<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - NexusForge</title>
  <link rel="stylesheet" href="Styles/style_dash.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="sessao.js"></script>
</head>

<body onload="iniciarDashboard()">
  <nav class="sidebar">
    <div class="logo">
      <div class="logo-texto">NexusForge</div>
    </div>

    <ul>
      <li><a href="#"><i class="fa-solid fa-chart-line"></i><span>Desempenho</span></a></li>
      <li><a href="quiz.html"><i class="fa-solid fa-clipboard-list"></i><span>Quiz</span></a></li>
      <li><a href="#" onclick="limparSessao()"><i class="fa-solid fa-right-from-bracket"></i><span>Sair</span></a></li>
    </ul>
  </nav>

  <main class="main-content">
    <div class="loading" id="loading">
      <div class="loading-box">
        <div class="loading-brilho"></div>
        <div class="loading-borda"></div>
        <div class="loading-icon"></div>
      </div>
    </div>
    <header class="header">
      <h1>Bem-vindo, <strong id="id_user"></strong> </h1>
    </header>

    <section class="player-card">
      <div class="card-frame">
        <div class="fundo"></div>
        <div class="info-topo">
          <span class="player-rating" id="id_nota"></span>
          <h2 class="player-name" id="id_name"></h2>
        </div>
        <div class="info-baixo">
          <div class="details">
            <p><strong>Campeão:</strong> <span id="id_champ"></span></p>
            <p><strong>KDA Médio:</strong> <span id="id_kdaM"></span> </p>
            <p><strong>Taxa de Vitória:</strong> <span id="id_Winrate"></span> </p>
          </div>
        </div>
      </div>
      <div class="grafico-box">
        <h2 class="titulo-grafico">Gráfico de Desempenho</h2>
        <canvas id="player-status"></canvas>
      </div>
    </section>

    <section class="status">
      <h2 class="status-titulo"><i class="fa-solid fa-chart-simple"></i> Resultados da última partida</h2>

      <div class="status-container">

        <div class="status-card">
          <span class="status-value" id="id_GPM">--</span>
          <span class="status-label">Ouro por Minuto</span>
        </div>

        <div class="status-card">
          <span class="status-value" id="id_KDA">--</span>
          <span class="status-label">KDA</span>
        </div>

        <div class="status-card">
          <span class="status-value" id="id_vision">--</span>
          <span class="status-label">Visão</span>
        </div>

        <div class="status-card">
          <span class="status-value" id="id_DPM">--</span>
          <span class="status-label">Dano por minuto</span>
        </div>

        <div class="status-card">
          <span class="status-value" id="id_CS">--</span>
          <span class="status-label">CS</span>
        </div>
      </div>
    </section>

  </main>
  <script src="radar.JS"></script>
</body>

</html>
<script>
  async function iniciarDashboard() {
    // Enquanto a função obterDados estiver "carregando" o style de carregamento aparece na tela e some quando a função se encerra
    try {
      document.getElementById("loading").style.display = "flex";
      await obterDados();

    } finally {
      document.getElementById("loading").style.display = "none";
    }
  }

  async function obterDados() {
    console.time('TempoLoading')
    const riotAccount = sessionStorage.RIOT_ACCOUNT;
    const riotId = sessionStorage.RIOT_TAG;
    const apiKey = "RGAPI-99a35c8a-2729-4ca5-8847-e03435b2a557";

    try {
      // Adquiri o nome e tag do usuario
      const contaResponse = await fetch(
        `https://americas.api.riotgames.com/riot/account/v1/accounts/by-riot-id/${riotAccount}/${riotId}?api_key=${apiKey}`
      );
      if (!contaResponse.ok) throw new Error("Conta não encontrada");
      const conta = await contaResponse.json();


      // Adquiri o puuid
      const summonerResponse = await fetch(
        `https://br1.api.riotgames.com/lol/summoner/v4/summoners/by-puuid/${conta.puuid}?api_key=${apiKey}`
      );
      if (!summonerResponse.ok)
        throw new Error("Jogador não encontrado no LoL");
      const summoner = await summonerResponse.json();


      // Adquiri a versão da datadragon (API imgs) e insere o icone no card
      const iconResponse = await fetch(
        "https://ddragon.leagueoflegends.com/api/versions.json"
      );
      if (!iconResponse.ok)
        throw new Error("Versões não encontradas");
      const versions = await iconResponse.json();
      var iconUser = `https://ddragon.leagueoflegends.com/cdn/${versions[0]}/img/profileicon/${summoner.profileIconId}.png`
      const fundo = document.querySelector(".fundo");
      fundo.style.backgroundImage = `url("${iconUser}"), linear-gradient(135deg, #6a00ff, #d400ff, #ff0080)`;
      console.log(iconUser);



      // Adquiri o id das ultimas 10 partidas solo/duo
      const partidaResponse = await fetch(
        `https://americas.api.riotgames.com/lol/match/v5/matches/by-puuid/${conta.puuid}/ids?type=ranked&queue=420&count=10&api_key=${apiKey}`
      );
      if (!partidaResponse.ok)
        throw new Error("Nenhuma partida encontrada");
      const partida = await partidaResponse.json();


      //  Adquiri os dados das 10 partidas (espera receber a resposta de uma requisição para começar outra)



      const partidasDetalhes = [];

      for (let i = 0; i < partida.length; i++) {
        const matchId = partida[i];

        const res = await fetch(
          `https://americas.api.riotgames.com/lol/match/v5/matches/${matchId}?api_key=${apiKey}`
        );
        const dadosMatch = await res.json();

        partidasDetalhes.push(dadosMatch);

      }


      //  Filtra o jogador e adquiri os dados dele

      const minhasPartidas = [];

      for (let partidaAtual = 0; partidaAtual < partidasDetalhes.length; partidaAtual++) {
        const match = partidasDetalhes[partidaAtual];

        // Variavel dos dados do jogador
        let p = null;

        // Procurar o id do jogador correto
        for (let j = 0; j < match.info.participants.length; j++) {
          if (match.info.participants[j].puuid === conta.puuid) {
            p = match.info.participants[j];
            break; // quando achar o id para o loop
          }
        }

        // Dados do array final
        minhasPartidas.push({
          champion: p.championName,
          individualPosition: p.individualPosition,
          lane: p.lane,
          win: p.win,
          kills: p.kills,
          deaths: p.deaths,
          assists: p.assists,
          kda: Number(((p.kills + p.assists) / Math.max(1, p.deaths)).toFixed(2)),
          cs: p.totalMinionsKilled + p.neutralMinionsKilled,
          damagePerMinute: p.challenges.damagePerMinute,
          goldPerMinute: p.challenges.goldPerMinute,
          visionScore: p.visionScore,
          objectives: p.challenges.objectiveControlPercentage,
          gameDuration: Number((match.info.gameDuration / 60).toFixed(2))
        });
      }
      console.log(minhasPartidas)

      console.log(minhasPartidas[0].individualPosition)
      id_CS.innerHTML = `${(minhasPartidas[0].cs).toFixed(2)}`;
      id_DPM.innerHTML = `${(minhasPartidas[0].damagePerMinute).toFixed(2)}`;
      id_GPM.innerHTML = `${(minhasPartidas[0].goldPerMinute).toFixed(2)}`;
      id_vision.innerHTML = `${(minhasPartidas[0].visionScore).toFixed(2)}`;
      id_KDA.innerHTML = `${(minhasPartidas[0].kda).toFixed(2)}`;

      // Soma dos Dados das 20 partidas

      const dadosSoma = {
        kda: 0,
        cs: 0,
        dpm: 0,
        gpm: 0,
        vision: 0,
        objectives: 0
      }
      for (var j = 0; j < minhasPartidas.length; j++) {
        dadosSoma.kda += minhasPartidas[j].kda;
        dadosSoma.cs += (minhasPartidas[j].cs / minhasPartidas[j].gameDuration);
        dadosSoma.dpm += minhasPartidas[j].damagePerMinute;
        dadosSoma.gpm += minhasPartidas[j].goldPerMinute;
        dadosSoma.vision += minhasPartidas[j].visionScore;
        dadosSoma.objectives += minhasPartidas[j].objectives;
      }

      // Média das Somas

      const qtd = minhasPartidas.length;

      const medias = {
        kda: Number((dadosSoma.kda / qtd).toFixed(2)),
        cs: Number((dadosSoma.cs / qtd).toFixed(2)),
        dpm: Number((dadosSoma.dpm / qtd).toFixed(2)),
        gpm: Number((dadosSoma.gpm / qtd).toFixed(2)),
        vision: Number((dadosSoma.vision / qtd).toFixed(2)),
        objectives: dadosSoma.objectives / qtd
      };


      // chama a função mediasProntas para montar o chartJS com a variavel window.medias
      window.medias = medias;
      mediasProntas()


      // Inserção do nome do usuario na pagina
      id_user.innerHTML = sessionStorage.NOME_USUARIO;
      id_name.innerHTML = sessionStorage.RIOT_ACCOUNT;

      // Calculo de Taxa de Vitória 
      var vitorias = 0;
      var derrotas = 0;
      
      // Verifica o resultado de cada partida
      for (let cont = 0; cont < minhasPartidas.length; cont++) {
        const resultadoJogo = minhasPartidas[cont].win;
        
        if(resultadoJogo == true){
          vitorias++;
        }else {
          derrotas++;
        }
        
      }

      const winrate = ((vitorias / minhasPartidas.length) * 100).toFixed(1);



      // Inserção da nota do Usuario

      // Peso de cada status na nota
      const pesos = {
        kda: 0.18,
        cs: 0.25,
        dpm: 0.18,
        gpm: 0.08,
        vision: 0.16,
        winrate: 0.15
      };

      // Valor ideal/maximo de cada status
      const ideal = {
        kda: 4.0,
        cs: 8,
        dpm: 500,
        gpm: 380,
        vision: 25,
        winrate: 60
      };

      // Função de calculo (real / ideal) Math.min mantem o menor numero 
      function score(real, ideal) {
        return Math.min(real / ideal, 1);
      }

      const nota =
        score(medias.kda, ideal.kda) * pesos.kda +
        score(medias.cs, ideal.cs) * pesos.cs +
        score(medias.dpm, ideal.dpm) * pesos.dpm +
        score(medias.gpm, ideal.gpm) * pesos.gpm +
        score(medias.vision, ideal.vision) * pesos.vision +
        score(winrate, ideal.winrate) * pesos.winrate;

      const notaFinal = Math.round(nota * 100);
      console.log(notaFinal);
      id_nota.innerHTML = `${notaFinal}`


      // Dados do card

      // Campeão mais jogado
      var contador = {};
      var maisJogado = "";
      var maiorQtd = 0;

      for (var c = 0; c < minhasPartidas.length; c++) {
        const champ = minhasPartidas[c].champion;
        contador[champ] = (contador[champ] || 0) + 1;

        if (contador[champ] > maiorQtd) {
          maiorQtd = contador[champ];
          maisJogado = champ;
        }
      }

      
      // KDA Médio 
      const kdaMedio = medias.kda.toFixed(2);

      id_champ.innerHTML = maisJogado;
      id_kdaM.innerHTML = kdaMedio;
      id_Winrate.innerHTML = `${winrate}%`;


    } catch (err) {
      resultado.textContent = "Erro: " + err.message;
      resultado.style.color = "red";
    }
    console.timeEnd('TempoLoading')
  }
  
</script>